mutate(treat_categorical4 = factor(treat_categorical4,
levels = c('NoChange',
'DecAndInc',
'Increase',
'Decrease')))
#### Pre post 2000 using other periods ####
m1 <- feols(polar_bund_alt_diff ~ treat_categorical4 | year ,
data = btw %>% filter(year < 2000),
cluster = ~ county_id_2018)
m2 <- feols(polar_bund_alt_diff ~ treat_categorical4 | year,
data = btw %>% filter(year < 1998),
cluster = ~ county_id_2018)
m3 <- feols(small_party_zweit_diff ~ treat_categorical4 |   year,
data = btw %>% filter(year < 2000),
cluster = ~ county_id_2018)
m4 <- feols(small_party_zweit_diff ~ treat_categorical4 |  year,
data = btw%>% filter(year < 1998),
cluster = ~ county_id_2018)
m5 <- feols(polar_bund_alt_diff ~ treat_categorical4 | year ,
data = btw %>% filter(year > 2000),
cluster = ~ county_id_2018)
m6 <- feols(polar_bund_alt_diff ~ treat_categorical4 | year,
data = btw %>% filter(year >= 1998),
cluster = ~ county_id_2018)
m7 <- feols(small_party_zweit_diff ~ treat_categorical4 |   year,
data = btw %>% filter(year > 2000),
cluster = ~ county_id_2018)
m8 <- feols(small_party_zweit_diff ~ treat_categorical4 |  year,
data = btw%>% filter(year >= 1998),
cluster = ~ county_id_2018)
list(m1, m2, m3, m4, m5, m6, m7, m8) %>%
haschaR::tidy_feols() %>%
filter(str_detect(term, 'Decrease')) %>%
dplyr::select(estimate, p.value, dv, n) %>%
mutate(sample = c('<00', '<98', '<00', '<98',
'>00', '>=98', '>00', '>=98')) %>%
arrange(sample, dv)
#### Year times East ####
library(fixest)
m1 <- feols(polar_bund_alt_diff ~ treat_categorical4 | year ,
data = btw %>% filter(year < 2000),
cluster = ~ county_id_2018)
m2 <- feols(small_party_zweit_diff ~ treat_categorical4 | year,
data = btw %>% filter(year < 2000),
cluster = ~ county_id_2018)
m3 <- feols(polar_bund_alt_diff ~ treat_categorical4 |   year^east,
data = btw %>% filter(year < 2000),
cluster = ~ county_id_2018)
m4 <- feols(small_party_zweit_diff ~ treat_categorical4 |  year^east,
data = btw%>% filter(year < 2000),
cluster = ~ county_id_2018)
setFixest_dict(c(treat_categorical4Decrease = 'Newspaper exit',
polar_bund_alt_diff = 'Polarization',
small_party_zweit_diff = 'Small party vote share (0-1)',
small_party_diff = 'Small party vote share (0-1)',
year = 'Year',
east = 'East Germany',
county_id_2018 = 'County-level'))
#### De Chaisemartin ####
##  Treatment defined as decrease (binary)
btw <- btw %>%
mutate(treat_decrease = 1*(treat_categorical4 == 'Decrease'))
## Def tidy function ##
tidy.did_multiplegt = function(x, level = 0.95) {
ests = x[grepl("^placebo_|^effect|^dynamic_", names(x))]
ret = data.frame(
term      = names(ests),
estimate  = as.numeric(ests),
std.error = as.numeric(x[grepl("^se_placebo|^se_effect|^se_dynamic", names(x))]),
N         = as.numeric(x[grepl("^N_placebo|^N_effect|^N_dynamic", names(x))])
)  %>%
# For CIs we'll assume standard normal distribution
mutate(
conf.low  = estimate - std.error*(qnorm(1-(1-level)/2)),
conf.high = estimate + std.error*(qnorm(1-(1-level)/2)),
t.stat = estimate / std.error,
p.value = 2*(1-pnorm(abs(t.stat))))
return(ret)
}
## Test run
library(DIDmultiplegt)
## Overall
set.seed(123)
out <- did_multiplegt(cluster = "county_id_2018",
brep = 2,
df = btw %>%
filter(year < 2001),
Y = "polar_bund_alt",
G = "county_id_2018",
T = "year",
D = "treat_decrease")
dh1 <- tidy.did_multiplegt(out)%>%
dplyr::rename(n = N)
tidy.did_multiplegt(out)
set.seed(123)
out_sp <- did_multiplegt(cluster = "county_id_2018",
brep = 2,
df = btw %>%
filter(year < 2001),
Y = "small_party_zweit",
G = "county_id_2018",
T = "year",
D = "treat_decrease")
dh2 <- tidy.did_multiplegt(out_sp) %>%
dplyr::rename(n = N)
tidy.did_multiplegt(out_sp)
## Get results
out_table <- bind_rows(m1 %>% tidy_feols(),
m3 %>% tidy_feols(),
dh1,
m2 %>% tidy_feols(),
m4 %>% tidy_feols(),
dh2) %>%
filter(str_detect(term, "effect|Decrease")) %>%
dplyr::select(estimate, std.error, p.value, n, rsq) %>%
mutate(outcome = rep(c("polar", "small_party"),each =3)) %>%
mutate(fe = rep(c("year", "year*east", "chaisemartin"), 2))
out_table
## Add these to the table?
dummy_m1 <- m1
dummy_m1$coefficients["treat_categorical4Decrease"] <-  dh1$estimate
dummy_m1$se["treat_categorical4Decrease"] <- dh1$std.error
dummy_m1$nobs <- dh1$N
dummy_m2 <- m2
dummy_m2$coefficients["treat_categorical4Decrease"] <-  dh2$estimate
dummy_m2$se["treat_categorical4Decrease"] <- dh2$std.error
dummy_m2$nobs <- dh2$N
## Table
mlist <- list(m1, m3, dummy_m1, m2, m4, dummy_m2) %>%
haschaR::tidy_feols() %>%
filter(term == 'treat_categorical4Decrease')
## Table
etable(mlist, tex = TRUE, cluster = 'county_id_2018',
keep = 'exit',
digits = 3,
digits.stats = 3,
fixef_sizes=  F,
style.tex = style.tex("qje",
yesNo = c("Yes", "No"),
fixef.where = 'var',
fixef.suffix = ' FEs',
tablefoot = T,
tablefoot.value = 'default'),
fitstat = ~ r2 + n,
title = 'Results allowing for differential trends between East and West Germany')
m3 <- feols(split_ticket_abs ~ treat_categorical4 |   year,
data = btw %>% filter(year > 2000),
cluster = ~ county_id_2018)
## BTW
rm(list = ls())
##
res <- read_rds('03_Results/04_Estimates/Election_Estimates_Full.rds') %>%
mutate(effect_sd = estimate / dv_sd)
#### Main effects ####
res_tab <- res %>%
filter(str_detect(outcome, 'polar_bund_diff|small_party')) %>%
filter(str_detect(ss, 'Combined|Pre|Post|NoEastIn94')) %>%
filter(!str_detect(outcome, 'small_party2')) %>%
filter(period_numeric == 1) %>%
filter(str_detect(term, 'Decrease')) %>%
mutate(outcome = dplyr::recode(outcome,
`small_party_diff` = 'Small party vote share',
`polar_bund_diff` = 'Polarization')) %>%
filter(!unit == 'State election') %>%
filter(fe %in% c('Covars + Year FE', 'Year FE')) %>%
arrange(ss) %>%
dplyr::select(-period, -term, -conf.low, -conf.high,
-east, -period_numeric, -conf.low90, -conf.high90,
-main_spec, -effect_sd) %>%
mutate(fe = as.character(fe),
unit = as.character(unit)) %>%
dplyr::select(ss, outcome, unit, fe, estimate, std.error, statistic, p.value, n) %>%
mutate(ss = dplyr::recode(ss,
`NoEastIn94` = '4. Full sample (omitting East Germany in 1994)',
`Combined` = '1. Full sample',
`Post 2005` = '3. After 2000',
`Pre 2005` = '2. Before 2000')) %>%
arrange(ss) %>%
mutate(unit = str_remove(unit, ' election'))
## Make table
## Groupings
gr <- res_tab %>% ungroup() %>%
mutate(rowid = 1:n()) %>%
group_by(ss) %>%
summarise(first = first(rowid),
last = last(rowid)) %>%
data.frame(stringsAsFactors = F)
## Table
kable(res_tab %>% dplyr::select(-ss),
"latex",
longtable = F,
booktabs = T, col.names = c('Outcome',
'Election',
'Model',
'Estimate',
'SE',
'T-stat',
'P',
'N'),
linesep = "",
caption = 'Main results',
label = 'tab:main_appendix',
escape = F, digits = 3) %>%
kable_styling(latex_options = c("repeat_header"),
font_size = 10) %>%
# collapse_rows() %>%
row_spec(0, bold = T) %>%
column_spec(1, width = '4.5cm') %>%
kable_styling(latex_options = "HOLD_position") %>%
pack_rows(gr[1, 'ss'], gr[1, 'first'], gr[1, 'last'],
hline_after = F) %>%
pack_rows(gr[2, 'ss'], gr[2, 'first'], gr[2, 'last'],
hline_after = F) %>%
pack_rows(gr[3, 'ss'], gr[3, 'first'], gr[3, 'last'],
hline_after = F)%>%
pack_rows(gr[4, 'ss'], gr[4, 'first'], gr[4, 'last'],
hline_after = F)
#### Manual regressions ####
## Load Data
btw <- readRDS('01_Data/BTW_News_Polarization_Covs.RDS') %>%
mutate(treat_categorical4 = factor(treat_categorical4,
levels = c('NoChange',
'DecAndInc',
'Increase',
'Decrease'))) %>%
filter(!year == 2013) %>%
mutate(y_new = small_party_zweit_diff - left_zweit_diff)
## Muni data
muni <- readRDS('01_Data/MUNI_news_merged_Covs.RDS') %>%
mutate(treat_categorical4 = factor(treat_categorical4,
levels = c('NoChange',
'DecAndInc',
'Increase',
'Decrease')))
#### Pre post 2000 using other periods ####
m1 <- feols(polar_bund_alt_diff ~ treat_categorical4 | year ,
data = btw %>% filter(year < 2000),
cluster = ~ county_id_2018)
m2 <- feols(polar_bund_alt_diff ~ treat_categorical4 | year,
data = btw %>% filter(year < 1998),
cluster = ~ county_id_2018)
m3 <- feols(small_party_zweit_diff ~ treat_categorical4 |   year,
data = btw %>% filter(year < 2000),
cluster = ~ county_id_2018)
m4 <- feols(small_party_zweit_diff ~ treat_categorical4 |  year,
data = btw%>% filter(year < 1998),
cluster = ~ county_id_2018)
m5 <- feols(polar_bund_alt_diff ~ treat_categorical4 | year ,
data = btw %>% filter(year > 2000),
cluster = ~ county_id_2018)
m6 <- feols(polar_bund_alt_diff ~ treat_categorical4 | year,
data = btw %>% filter(year >= 1998),
cluster = ~ county_id_2018)
m7 <- feols(small_party_zweit_diff ~ treat_categorical4 |   year,
data = btw %>% filter(year > 2000),
cluster = ~ county_id_2018)
m8 <- feols(small_party_zweit_diff ~ treat_categorical4 |  year,
data = btw%>% filter(year >= 1998),
cluster = ~ county_id_2018)
list(m1, m2, m3, m4, m5, m6, m7, m8) %>%
haschaR::tidy_feols() %>%
filter(str_detect(term, 'Decrease')) %>%
dplyr::select(estimate, p.value, dv, n) %>%
mutate(sample = c('<00', '<98', '<00', '<98',
'>00', '>=98', '>00', '>=98')) %>%
arrange(sample, dv)
#### Year times East ####
library(fixest)
m1 <- feols(polar_bund_alt_diff ~ treat_categorical4 | year ,
data = btw %>% filter(year < 2000),
cluster = ~ county_id_2018)
m2 <- feols(small_party_zweit_diff ~ treat_categorical4 | year,
data = btw %>% filter(year < 2000),
cluster = ~ county_id_2018)
m3 <- feols(polar_bund_alt_diff ~ treat_categorical4 |   year^east,
data = btw %>% filter(year < 2000),
cluster = ~ county_id_2018)
m4 <- feols(small_party_zweit_diff ~ treat_categorical4 |  year^east,
data = btw%>% filter(year < 2000),
cluster = ~ county_id_2018)
setFixest_dict(c(treat_categorical4Decrease = 'Newspaper exit',
polar_bund_alt_diff = 'Polarization',
small_party_zweit_diff = 'Small party vote share (0-1)',
small_party_diff = 'Small party vote share (0-1)',
year = 'Year',
east = 'East Germany',
county_id_2018 = 'County-level'))
#### De Chaisemartin ####
##  Treatment defined as decrease (binary)
btw <- btw %>%
mutate(treat_decrease = 1*(treat_categorical4 == 'Decrease'))
## Def tidy function ##
tidy.did_multiplegt = function(x, level = 0.95) {
ests = x[grepl("^placebo_|^effect|^dynamic_", names(x))]
ret = data.frame(
term      = names(ests),
estimate  = as.numeric(ests),
std.error = as.numeric(x[grepl("^se_placebo|^se_effect|^se_dynamic", names(x))]),
N         = as.numeric(x[grepl("^N_placebo|^N_effect|^N_dynamic", names(x))])
)  %>%
# For CIs we'll assume standard normal distribution
mutate(
conf.low  = estimate - std.error*(qnorm(1-(1-level)/2)),
conf.high = estimate + std.error*(qnorm(1-(1-level)/2)),
t.stat = estimate / std.error,
p.value = 2*(1-pnorm(abs(t.stat))))
return(ret)
}
## Test run
library(DIDmultiplegt)
## Overall
set.seed(123)
out <- did_multiplegt(cluster = "county_id_2018",
brep = 2,
df = btw %>%
filter(year < 2001),
Y = "polar_bund_alt",
G = "county_id_2018",
T = "year",
D = "treat_decrease")
dh1 <- tidy.did_multiplegt(out)%>%
dplyr::rename(n = N)
tidy.did_multiplegt(out)
set.seed(123)
out_sp <- did_multiplegt(cluster = "county_id_2018",
brep = 2,
df = btw %>%
filter(year < 2001),
Y = "small_party_zweit",
G = "county_id_2018",
T = "year",
D = "treat_decrease")
dh2 <- tidy.did_multiplegt(out_sp) %>%
dplyr::rename(n = N)
tidy.did_multiplegt(out_sp)
## Get results
out_table <- bind_rows(m1 %>% tidy_feols(),
m3 %>% tidy_feols(),
dh1,
m2 %>% tidy_feols(),
m4 %>% tidy_feols(),
dh2) %>%
filter(str_detect(term, "effect|Decrease")) %>%
dplyr::select(estimate, std.error, p.value, n, rsq) %>%
mutate(outcome = rep(c("polar", "small_party"),each =3)) %>%
mutate(fe = rep(c("year", "year*east", "chaisemartin"), 2))
out_table
## Add these to the table?
dummy_m1 <- m1
dummy_m1$coefficients["treat_categorical4Decrease"] <-  dh1$estimate
dummy_m1$se["treat_categorical4Decrease"] <- dh1$std.error
dummy_m1$nobs <- dh1$N
dummy_m2 <- m2
dummy_m2$coefficients["treat_categorical4Decrease"] <-  dh2$estimate
dummy_m2$se["treat_categorical4Decrease"] <- dh2$std.error
dummy_m2$nobs <- dh2$N
## Table
mlist <- list(m1, m3, dummy_m1, m2, m4, dummy_m2) %>%
haschaR::tidy_feols() %>%
filter(term == 'treat_categorical4Decrease')
## Table
etable(mlist, tex = TRUE, cluster = 'county_id_2018',
keep = 'exit',
digits = 3,
digits.stats = 3,
fixef_sizes=  F,
style.tex = style.tex("qje",
yesNo = c("Yes", "No"),
fixef.where = 'var',
fixef.suffix = ' FEs',
tablefoot = T,
tablefoot.value = 'default'),
fitstat = ~ r2 + n,
title = 'Results allowing for differential trends between East and West Germany')
btw <- btw %>%
left_join(spl) %>%
mutate(split_ticket_abs = split_ticket_abs * 100)
spl <- read_rds("01_Data/Bundestagswahlen/Split_Ticket.rds") %>%
mutate(year = as.numeric(year))
btw <- btw %>%
left_join(spl) %>%
mutate(split_ticket_abs = split_ticket_abs * 100)
m1 <- feols(split_ticket_abs ~ treat_categorical4 | year ,
data = btw,
cluster = ~ county_id_2018)
m2 <- feols(split_ticket_abs ~ treat_categorical4 | year,
data = btw %>% filter(year < 2000),
cluster = ~ county_id_2018)
m3 <- feols(split_ticket_abs ~ treat_categorical4 |   year,
data = btw %>% filter(year > 2000),
cluster = ~ county_id_2018)
list(m1, m2, m3) %>%
haschaR::tidy_feols() %>%
filter(str_detect(term, 'Decrease')) %>%
dplyr::select(estimate, p.value, dv, n) %>%
mutate(sample = c('Full', '<00', '>00'))
list(m1, m2, m3) %>%
haschaR::tidy_feols() %>%
filter(str_detect(term, 'Decrease')) %>%
dplyr::select(term, estimate, p.value, dv, n) %>%
mutate(sample = c('Full', '<00', '>00'))
rm(list = ls())
## Load Data
## Keep east in for now
muni <- readRDS('01_Data/MUNI_news_merged_Covs.RDS') %>%
dplyr::select(county_id_2018,
year,
matches('diff'),
east,
state_year,
treat_categorical,
treat_categorical4,
matches('covars'),
state) %>%
mutate(treat_categorical4 = factor(treat_categorical4,
levels = c('NoChange',
'DecAndInc',
'Increase',
'Decrease')))
outcomes <- c("spd_diff", "greens_diff",
"fdp_diff", "cdu_csu_diff",
'left_diff',
"big_party_diff",
"small_party_diff",
"small_party2_diff",
"other_parties_diff",
"right_total_diff",
"left_total_diff",
"turnout_diff",
"polar_bund_diff",
"polar_land_diff",
"polar_unit_diff",
"polar_bund_alt_diff",
"polar_land_alt_diff",
"polar_unit_alt_diff",
"local_party_diff")
covars <- colnames(muni) %>%
.[str_detect(., 'covar')]%>%
str_filter('emp', neg = T)
sapply(covars,
function(x) sum(!is.na(muni[, x])) / nrow(muni))
ss_list <- list(muni,
muni %>% filter(!(east == 1 & year == 1994)),
muni %>% filter(year < 2001))
ss_labels <- c('Combined',
'NoEastIn94',
'Pre 2000')
res <- lapply(outcomes, function(o) {
lapply(1:length(ss_list), function(i) {
cat(i, o)
## Get DF
df_temp <- ss_list[[i]]
ss_label = ss_labels[i]
## Message
print(o)
## Prep
df_temp$outcome <- df_temp %>% pull(!!o)
df_temp <- df_temp %>%
filter(!is.na(outcome) & !is.na(treat_categorical)) %>%
dplyr::select(outcome, year, county_id_2018,
state_year, treat_categorical, east,
treat_categorical4,
state, one_of(covars))
## Estimate
m1 <- felm(outcome ~ treat_categorical4 | year | 0 | county_id_2018,
data = df_temp) %>%
haschaR::tidy_felm()  %>%
mutate(fe = 'year')
m2 <- felm(outcome ~ treat_categorical4 | state | 0 | county_id_2018,
data = df_temp) %>%
haschaR::tidy_felm() %>%
mutate(fe = 'state')
m3 <- felm(outcome ~ treat_categorical4 | 0 | 0 | county_id_2018,
data = df_temp) %>%
haschaR::tidy_felm() %>%
mutate(fe = 'none')
m4 <- felm(outcome ~ treat_categorical4 | state_year | 0 | county_id_2018,
data = df_temp) %>%
haschaR::tidy_felm()  %>%
mutate(fe = 'state_year')
## Year + covars
f <- paste0('outcome ~ treat_categorical4 +',
paste0(covars, collapse = '+'),
'| year | 0 | county_id_2018') %>%
as.formula()
m5 <- felm(f, data = df_temp) %>%
haschaR::tidy_felm()  %>%
mutate(fe = 'year_covars')
## Combine
rbind(m1, m2, m3, m4, m5) %>%
mutate(east = c('All'),
outcome = !!o,
ss = ss_label)
}) %>% reduce(rbind)
}) %>% reduce(rbind) %>%
mutate(period = 'now')  %>%
filter(!str_detect(term, 'Intercept|covar'))
library(devtools)
library(roxygen2)
rm(list = ls())
library(devtools)
library(roxygen2)
rm(list = ls())
## Declare WDs
wd_h <- '~/Documents/GitHub/haschaR/'
wd_s <- '/Users/saschariaz_1/Dropbox\ (Nuffield\ College)/07_Git/haschaR'
## Set WD
haschaR::detect_wd(wd_h = wd_h, wd_alt = wd_s, user_name = 'hanno',
wd_h2 = wd_h2)
document()
devtools::install_github('hhilbig/haschaR',
upgrade = T, force = T, quiet = T)

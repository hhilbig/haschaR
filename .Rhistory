library(geosphere)
library(StatMatch)
## WD
setwd("C:/Users/hanno/Dropbox/Harvard/Projects/03_HannoProjects")
haschaR::auto_make_runall_file('Code/')
## 01 Cleanup
## 03 Analysis
source("Code/03_Analysis/01_DiD_TwoPeriod.R")
source("Code/03_Analysis/02_DiD_LagLead.R")
source("Code/03_Analysis/03_DiD_LagLead_Matching.R")
source("Code/03_Analysis/04_DiD_TwoPeriod_Matching.R")
## 03 Analysis/01 HTE
source("Code/03_Analysis/01_HTE/01_DiD_TwoPeriod_HTE.R")
source("Code/03_Analysis/01_HTE/02_DiD_TwoPeriod_Matching_HTE.R")
source("Code/03_Analysis/01_HTE/03_DiD_TwoPeriod_HTE_Overlapping.R")
source("Code/03_Analysis/01_HTE/04_HTE_Overlapping_Sens.R")
source("Code/03_Analysis/01_HTE/05_DiD_LagLead_HTE.R")
source("Code/03_Analysis/01_HTE/06_DiD_TwoPeriod_HTE_Parties.R")
source("Code/03_Analysis/01_HTE/07_DiD_TwoPeriod_HTE_Competitiveness.R")
source("Code/03_Analysis/01_HTE/08_DiD_TwoPeriod_HTE_Timing.R")
## 03 Analysis/02 DiD Additional
source("Code/03_Analysis/02_DiD_Additional/01_DiD_NewEstimators.R")
source("Code/03_Analysis/02_DiD_Additional/02_DiD_LagLead_LongPanel.R")
source("Code/03_Analysis/02_DiD_Additional/03_DiD_TwoPeriod_LeaveOutStates.R")
## 03 Analysis/03 Do Matching
source("Code/03_Analysis/03_Do_Matching/01_Do_Matching_DiD.R")
source("Code/03_Analysis/03_Do_Matching/01b_Do_Matching_Overlapping.R")
source("Code/03_Analysis/03_Do_Matching/02_DoMatching_Newspapers_Distance.R")
source("Code/03_Analysis/03_Do_Matching/03_DoMatching_Newspapers_Create_Many_Datasets.R")
## 03 Analysis/04 Additional
source("Code/03_Analysis/04_Additional/01_Civey_Data.R")
source("Code/03_Analysis/04_Additional/02_DAG.R")
source("Code/03_Analysis/04_Additional/03_IMF_Data_Decentralization.R")
rm(list = ls())
##
out <- read_rds("Results/Estimates/Est_DiD_HTE.rds") %>%
filter(str_detect(model, "3")) %>%
mutate_at(vars(estimate, matches("conf")),
list(~. / dv_sd)) %>%
mutate(covars = ifelse(covars == 1, "Covariates",
"No covariates")) %>%
filter(str_detect(treatvar, "mean|cont_no_outlier"))
## Naming
measures <- read_xlsx('measures.xlsx')
out <- left_join(out,
measures %>% dplyr::select(varlab, label),
by = c("treatvar" = "varlab")) %>%
mutate(treatvar = label) %>%
dplyr::select(-label)
out <- left_join(out,
measures %>% dplyr::select(varlab, label),
by = c("htevar" = "varlab")) %>%
mutate(htevar = label) %>%
dplyr::select(-label)
out <- left_join(out,
measures %>% dplyr::select(varlab, label),
by = c("outcome" = "varlab")) %>%
mutate(outcome = label) %>%
dplyr::select(-label) %>%
mutate(outcome = haschaR::add_linebreak_vector(outcome, 10))
pd <- position_dodge(0.75)
p1 <- ggplot(out %>% filter(ss == 'Full sample') %>%
filter(str_detect(treatvar, 'Mean')),
aes(x = term, y = estimate,
ymin = conf.low, ymax = conf.high,
group = factor(covars))) +
geom_hline(yintercept = 0, linetype = 'dotted', color = 'grey40') +
geom_errorbar(width = 0,
position = pd,
aes(color = covars)) +
geom_point(shape = 21,
position = pd,
aes(fill = covars)) +
theme_hanno() +
facet_grid(htevar~ outcome, scales = 'free') +
ylab('Effect of negative fiscal shock due to 2008 crisis\n(standard deviations)') +
theme(legend.position = 'bottom') +
xlab('') +
coord_flip()
p1
ggsave("Plots/DiD/01_HTE/HTE_MeanTreat.pdf", width = 16, height =16)
p1 <- ggplot(out %>% filter(ss == 'Full sample') %>%
filter(!str_detect(treatvar, 'Mean')),
aes(x = term, y = estimate,
ymin = conf.low, ymax = conf.high,
group = factor(covars))) +
geom_hline(yintercept = 0, linetype = 'dotted', color = 'grey40') +
geom_errorbar(width = 0,
position = pd,
aes(color = covars)) +
geom_point(shape = 21,
position = pd,
aes(fill = covars)) +
theme_hanno() +
facet_grid(htevar~ outcome, scales = 'free') +
ylab('Effect of negative fiscal shock due to 2008 crisis\n(standard deviations)') +
theme(legend.position = 'bottom') +
xlab('') +
coord_flip()
p1
ggsave("Plots/DiD/01_HTE/HTE_ContTreat.pdf", width = 16, height = 16)
rm(list = ls())
out <- read_rds("Results/Estimates/Est_DiD_HTE_Weighted.rds") %>%
filter(str_detect(model, "3")) %>%
mutate_at(vars(estimate, matches("conf")),
list(~. / dv_sd)) %>%
mutate(covars = ifelse(covars == 1, "Covariates",
"No covariates")) %>%
filter(str_detect(treatvar, "mean|cont_no_outlier"))
measures <- read_xlsx("measures.xlsx") %>%
dplyr::select()
measures <- read_xlsx('measures.xlsx')
out <- left_join(out,
measures %>% dplyr::select(varlab, label),
by = c("treatvar" = "varlab")) %>%
mutate(treatvar = label) %>%
dplyr::select(-label)
out <- left_join(out,
measures %>% dplyr::select(varlab, label),
by = c("htevar" = "varlab")) %>%
mutate(htevar = label) %>%
dplyr::select(-label)
out <- left_join(out,
measures %>% dplyr::select(varlab, label),
by = c("outcome" = "varlab")) %>%
mutate(outcome = label) %>%
dplyr::select(-label) %>%
mutate(outcome = haschaR::add_linebreak_vector(outcome, 10))
pd <- position_dodge(0.75)
p1 <- ggplot(out %>% filter(ss == 'Full sample') %>%
filter(str_detect(treatvar, 'Mean')),
aes(x = term, y = estimate,
ymin = conf.low, ymax = conf.high,
group = factor(covars))) +
geom_hline(yintercept = 0, linetype = 'dotted', color = 'grey40') +
geom_errorbar(width = 0,
position = pd,
aes(color = covars)) +
geom_point(shape = 21,
position = pd,
aes(fill = covars)) +
theme_hanno() +
facet_grid(htevar~ outcome, scales = 'free') +
ylab('Effect of negative fiscal shock due to 2008 crisis\n(standard deviations)') +
theme(legend.position = 'bottom') +
xlab('') +
coord_flip()
p1
ggsave("Plots/DiD/01_HTE/HTE_MeanTreat_Weighted.pdf", width = 16, height = 16)
p1 <- ggplot(out %>% filter(ss == 'Full sample') %>%
filter(!str_detect(treatvar, 'Mean')),
aes(x = term, y = estimate,
ymin = conf.low, ymax = conf.high,
group = factor(covars))) +
geom_hline(yintercept = 0, linetype = 'dotted', color = 'grey40') +
geom_errorbar(width = 0,
position = pd,
aes(color = covars)) +
geom_point(shape = 21,
position = pd,
aes(fill = covars)) +
theme_hanno() +
facet_grid(htevar~ outcome, scales = 'free') +
ylab('Effect of negative fiscal shock due to 2008 crisis\n(standard deviations)') +
theme(legend.position = 'bottom') +
xlab('') +
coord_flip()
p1
ggsave("Plots/DiD/01_HTE/HTE_ContTreat_Weighted.pdf", width = 16, height = 16)
p1 <- ggplot(out %>% filter(covars == 'Covariates') %>%
filter(str_detect(treatvar, 'Mean')),
aes(x = term, y = estimate,
ymin = conf.low, ymax = conf.high,
group = factor(ss))) +
geom_hline(yintercept = 0, linetype = 'dotted', color = 'grey40') +
geom_errorbar(aes(ymin = conf.low90,
ymax = conf.high90,color = ss),
size = 1.2,
width = 0,
position = pd) +
geom_errorbar(width = 0,
position = pd,
aes(color = ss)) +
geom_point(shape = 21,
position = pd,
aes(fill = ss)) +
theme_hanno() +
facet_grid(htevar~ outcome, scales = 'free') +
ylab('Effect of negative fiscal shock due to 2008 crisis\n(standard deviations)') +
theme(legend.position = 'bottom') +
xlab('') +
coord_flip()
p1
ggsave("Plots/DiD/01_HTE/HTE_MeanTreat_Weighted.pdf", width = 16, height = 16)
p1 <- ggplot(out %>% filter(!covars == 'Covariates') %>%
filter(!str_detect(treatvar, 'Mean')),
aes(x = term, y = estimate,
ymin = conf.low, ymax = conf.high,
group = factor(ss))) +
geom_hline(yintercept = 0, linetype = 'dotted', color = 'grey40') +
geom_errorbar(width = 0,
position = pd,
aes(color = ss)) +
geom_point(shape = 21,
position = pd,
aes(fill = ss)) +
theme_hanno() +
facet_grid(htevar~ outcome, scales = 'free') +
ylab('Effect of negative fiscal shock due to 2008 crisis\n(standard deviations)') +
theme(legend.position = 'bottom') +
xlab('') +
coord_flip()
p1
ggsave("Plots/DiD/01_HTE/HTE_ContTreat_Weighted_OverTime.pdf", width = 16, height = 16)
rm(list = ls())
##
out <- read_rds("Results/Estimates/Est_DiD_HTE.rds") %>%
filter(str_detect(model, "3")) %>%
mutate_at(vars(estimate, matches("conf")),
list(~. / dv_sd)) %>%
mutate(covars = ifelse(covars == 1, "Covariates included",
"No covariates")) %>%
filter(outcome == 'gwbst') %>%
filter(treatvar == 'treat_mean') %>%
filter(htevar == 'hte_mean_muni') %>%
mutate(n = min(n)) %>%
mutate(model = paste0("Base specification\n (N = ", prettyNum(n,big.mark = ','), ')'))
out_o <- read_rds("Results/Estimates/Est_DiD_HTE_Overlapping_Sens.rds") %>%
mutate_at(vars(estimate, matches("conf")),
list(~. / dv_sd)) %>%
mutate(covars = ifelse(covars == 1, "Covariates included",
"No covariates")) %>%
filter(outcome == 'gwbst') %>%
filter(treatvar == 'treat_mean') %>%
filter(htevar == 'hte_mean_muni') %>%
filter(distance == 25 & M == 1) %>%
mutate(n = min(n)) %>%
mutate(model = paste0('Overlapping markets\ndesign (N = ', prettyNum(n,big.mark = ','), ')'))
out_final <- out %>%
bind_rows(out_o) %>%
mutate(term = ifelse(str_detect(term, "hte"), "Crisis shock *\ngreater media presence",
"Crisis shock")) %>%
mutate(term = fct_rev(term))
pd <- position_dodge(0.4)
p1 <- ggplot(out_final,
aes(x = term, y = estimate,
ymin = conf.low, ymax = conf.high,
group = factor(covars))) +
geom_hline(yintercept = 0, linetype = 'dotted', color = 'grey40') +
geom_errorbar(width = 0,
position = pd,
aes(color = covars)) +
geom_point(position = pd,
aes(fill = covars,
shape = covars,
color = covars),
size = 2) +
theme_hanno() +
facet_wrap(~ model) +
ylab('Effect on business tax multiplier\n(standard deviations)') +
theme(legend.position = 'bottom') +
scale_shape_manual(values = c(21, 22), name = '') +
scale_color_manual(values = c("black", "grey50"), name = '') +
scale_fill_manual(values = c("black", "grey50"), name = '') +
xlab('') +
coord_flip()
p1
## Save this
ggsave("Plots/DiD/01_HTE/HTE_Plot_Paper.pdf", width = 7, height = 3.5)
haschaR::move_plots_to_overleaf()
out_o <- read_rds("Results/Estimates/Est_DiD_HTE_Overlapping_Sens.rds") %>%
mutate_at(vars(estimate, matches("conf")),
list(~. / dv_sd)) %>%
mutate(covars = ifelse(covars == 1, "Covariates included",
"No covariates")) %>%
filter(outcome == 'gwbst') %>%
filter(treatvar == 'treat_mean') %>%
filter(htevar == 'hte_mean_muni') %>%
filter(M == 1 & distance > 20) %>%
mutate(n = min(n)) %>%
mutate(model = paste0('Overlapping markets\ndesign'))
out_final <- out %>%
mutate(distance = 'Full sample') %>%
bind_rows(out_o %>%
mutate(distance = as.character(distance))) %>%
mutate(term = ifelse(str_detect(term, "hte"), "Crisis shock *\ngreater media presence",
"Crisis shock")) %>%
mutate(term = fct_rev(term))
p1 <- ggplot(out_final,
aes(x = distance, y = estimate,
ymin = conf.low, ymax = conf.high,
group = factor(term))) +
geom_hline(yintercept = 0, linetype = 'dotted', color = 'grey40') +
geom_errorbar(width = 0,
position = pd,
aes(color = term)) +
geom_point(position = pd,
aes(fill = term,
shape = term,
color = term),
size = 2) +
theme_hanno() +
facet_grid(covars~ model, scales = 'free_x') +
ylab('Effect on business tax multiplier\n(standard deviations)') +
theme(legend.position = 'bottom') +
scale_shape_manual(values = c(21, 22), name = '') +
scale_color_manual(values = c("black", "grey50"), name = '') +
scale_fill_manual(values = c("black", "grey50"), name = '') +
xlab('Distance caliper in km')
p1
ggsave("Plots/DiD/01_HTE/HTE_Paper_Sens.pdf", width = 7, height = 5.6)
rm(list = ls())
## Get measures
measures <- read_excel("measures.xlsx")
## Get data
df <- read_rds("Data/Muni_Taxes/Muni_Taxes_Clean_WithElections_WithTreatment.rds") %>%
filter(year > 2005) %>%
filter(!is.na(treat_mean)) %>%
mutate(post = ifelse(year > 2009, 1, 0)) %>%
mutate(year_land = paste0(year, land))
outcomevars <- measures %>% filter(use_as_outcome_for_hte == 1) %>% pull(varlab)
treatvars <- measures %>% filter(use_as_treatment == 1) %>% pull(varlab)
covars <- measures %>% filter(use_as_control == 1) %>% pull(varlab)
htevars <- measures %>% filter(use_as_hte == 1) %>% pull(varlab)
cor(df[, htevars], use = 'complete.obs')
df %>%
dplyr::select(one_of(htevars)) %>%
summarise_all(mean, na.rm = T)
df <- df %>%
dplyr::select(one_of(treatvars),
one_of(outcomevars),
one_of(covars),
one_of(htevars),
year,
year_land,
ags,
post,
land,
muni_largest_group,
matches("hte"))
df <- df %>%
group_by(land) %>%
mutate_at(vars(one_of(outcomevars)),
list(~((. - mean(., na.rm = T))) / sd(., na.rm = T))) %>%
ungroup()
ss_list <- list(df)
ss_labels <- c("Full sample")
tv <- treatvars[1]
dv <- outcomevars[1]
ss_id <- 1
out <- lapply(1:length(ss_list), function(ss_id) {
pblapply(treatvars, function(tv) {
pblapply(htevars, function(hte) {
df_ss <- ss_list[[ss_id]]
## Treated and treated * post
df_ss$treat_temp <- df_ss %>% pull(!!tv)
df_ss$treat_temp_post <- df_ss$treat_temp * df_ss$post
df_ss$hte_var <- df_ss %>% pull(!!hte)
df_ss$hte_treat_temp_post <- df_ss$treat_temp_post * df_ss$hte_var
## Get results
results <- lapply(outcomevars, function(dv){
## 2WFE, land*year
model_formula4 <- as.formula(paste0(dv, ' ~ post + treat_temp + treat_temp_post',
'+ hte_var + hte_var*treat_temp +',
'hte_var*post + hte_treat_temp_post',
'| year_land + ags | 0 | ags'))
model_est4 <- felm(model_formula4, data = df_ss) %>%
tidy_felm() %>%
filter(str_detect(term, 'treat_temp_post')) %>%
mutate(outcome = paste(dv)) %>%
mutate(covars = 0) %>%
mutate(treatvar = tv,
htevar = hte) %>%
mutate(model = '3 2WFE w/ land * year FE')
## 2WFE w/ covars, land*year
model_formula5 <- as.formula(paste0(dv, ' ~ post + treat_temp + treat_temp_post',
'+ hte_var + hte_var*treat_temp +',
'hte_var*post + hte_treat_temp_post+',
paste0(covars, collapse = '+'),
'| year_land + ags | 0 | ags'))
model_est5 <- felm(model_formula5, data = df_ss) %>%
tidy_felm() %>%
filter(str_detect(term, 'treat_temp_post')) %>%
mutate(outcome = paste(dv)) %>%
mutate(covars = 1) %>%
mutate(treatvar = tv,
htevar = hte) %>%
mutate(model = '3 2WFE w/ land * year FE')
## Combine
rbind(model_est4, model_est5)
}) %>% reduce(rbind)
}) %>% reduce(rbind)
}) %>% reduce(rbind) %>%
mutate(ss = ss_labels[ss_id])
}) %>% reduce(rbind)
table(df$year)
table(df %>% filter(!is.na(gwbst)) %>% pull(year))
haschaR::check_missings_df(df = df,
varlist = c(covars, htevars, outcomevars, dv), group = "year")
group = 'year'
haschaR::check_missings_df(df = df,
varlist = c(covars, htevars, outcomevars, dv),
group = "year") %>%
dplyr::rename(!!group = gvar)
group = 'year'
out <- haschaR::check_missings_df(df = df,
varlist = c(covars, htevars, outcomevars, dv),
group = group)
out[, group] <- out[, "gvar"]
group = 'year'
varlist = c(covars, htevars, outcomevars, dv)
-c(group)
group
out %>%
pivot_longer(cols = -c(group))
out %>%
dplyr::select(-gvar) %>%
pivot_longer(cols = -c(group))
out %>%
dplyr::select(-gvar) %>%
pivot_longer(cols = -c(group)) %>%
ggplot(aes_string(x = group, y = "value")) +
geom_bar(stat = "identity") +
facet_wrap(~name)
out %>%
dplyr::select(-gvar) %>%
pivot_longer(cols = -c(group)) %>%
ggplot(aes_string(x = group, y = "value")) +
geom_bar(stat = "identity") +
facet_wrap(~name) +
ylab("Share missing") +
theme_hanno()
out %>%
dplyr::select(-gvar) %>%
pivot_longer(cols = -c(group)) %>%
ggplot(aes_string(x = group, y = "value")) +
geom_bar(stat = "identity") +
facet_wrap(~name) +
ylab("Share missing") +
theme_hanno() +
x_axis_90deg()
df
varlist
group
out <- df %>%
summarise(across(one_of(varlist),
~sum(is.na(.))/n())) %>%
mutate(across(one_of(varlist),
round, 2))
out
out <- df %>%
summarise(across(one_of(varlist),
~sum(is.na(.))/n())) %>%
mutate(across(one_of(varlist),
round, 8))
out %>%
pivot_longer(cols = all()) %>%
ggplot(aes_string(x = "name", y = "value")) +
geom_bar(stat = "identity") +
ylab("Share missing") +
theme_hanno() +
x_axis_90deg()
out %>%
pivot_longer(cols = all())
out %>%
pivot_longer()
out %>%
pivot_longer(cols = everything())
out %>%
pivot_longer(cols = everything()) %>%
ggplot(aes_string(x = "name", y = "value")) +
geom_bar(stat = "identity") +
ylab("Share missing") +
theme_hanno() +
x_axis_90deg()
df[, 'gvar'] <- df[, group]
out <- df %>%
group_by(gvar) %>%
summarise(across(one_of(varlist),
~sum(is.na(.))/n())) %>%
mutate(across(one_of(varlist),
round, 8))
out[, group] <- out[, "gvar"]
out %>%
dplyr::select(-gvar) %>%
pivot_longer(cols = -c(group)) %>%
ggplot(aes_string(x = group, y = "value")) +
geom_bar(stat = "identity") +
facet_wrap(~name) +
ylab("Share missing") +
theme_hanno() +
x_axis_90deg()
library(devtools)
library(roxygen2)
rm(list = ls())
## Declare WDs
wd_h <- '/Users/hanno/Local_Projects/haschaR/'
wd_s <- '/Users/saschariaz/Google\ Drive_Harvard/Git/haschaR'
## Set WD
haschaR::detect_wd(wd_h = wd_h, wd_alt = wd_s, user_name = 'Hanno')
document()
## PUSH BEFORE REINSTALLING
devtools::install_github('hhilbig/haschaR',
upgrade = T, force = T, quiet = T)
library(devtools)
library(roxygen2)
rm(list = ls())
## Declare WDs
wd_h <- '/Users/hanno/Local_Projects/haschaR/'
wd_s <- '/Users/saschariaz/Google\ Drive_Harvard/Git/haschaR'
install.packages('cli')
install.packages("cli")
